name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ç‰ˆæœ¬æ ‡ç­¾,å¦‚ v1.0.0

# é…ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„æº

jobs:
  # æµ‹è¯•ä»»åŠ¡ - åœ¨æ„å»ºå‰è¿è¡Œæ‰€æœ‰æµ‹è¯•
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run all tests
        run: npm run test:all

  # å‘å¸ƒä»»åŠ¡ - ä¸ºå¤šä¸ªå¹³å°æ„å»ºå¹¶å‘å¸ƒ
  release:
    name: Release - ${{ matrix.settings.platform }}
    needs: test  # ç¡®ä¿æµ‹è¯•é€šè¿‡åå†æ‰§è¡Œå‘å¸ƒ
    
    strategy:
      fail-fast: false
      matrix:
        settings:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.settings.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # macOS éœ€è¦é¢å¤–çš„ç›®æ ‡æ¶æ„
          targets: ${{ matrix.settings.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.settings.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS ä»£ç ç­¾åé…ç½®(å¯é€‰)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Windows ä»£ç ç­¾åé…ç½®(å¯é€‰)
          # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Tauri MD v__VERSION__'
          releaseBody: |
            ## ğŸ‰ Tauri Markdown Editor v__VERSION__

            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…

            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…:

            - **Windows**: `*-setup.exe` æ–‡ä»¶ (NSIS å®‰è£…ç¨‹åº,æ”¯æŒä¸­æ–‡ç•Œé¢)
            - **macOS**: `.dmg` æ–‡ä»¶ (æ”¯æŒ Intel å’Œ Apple Silicon)
            - **Linux**: `.AppImage` æˆ– `.deb` æ–‡ä»¶

            ### âœ¨ æ›´æ–°å†…å®¹

            è¯·æŸ¥çœ‹ä¸‹æ–¹çš„å®Œæ•´æ›´æ–°æ—¥å¿—ã€‚

            ---

            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v0.1.0...${{ github.ref_name }}
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.settings.args }}

  # å‘å¸ƒ Release (å°†è‰ç¨¿è½¬ä¸ºæ­£å¼å‘å¸ƒå¹¶æ›´æ–°è¯´æ˜)
  publish-release:
    name: Publish Release
    needs: release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "changelog=é¦–æ¬¡å‘å¸ƒ" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆæ›´æ–°æ—¥å¿—
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Publish and Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–è‰ç¨¿ Release ID
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }} --jq '.id')

          # ç”Ÿæˆ Release è¯´æ˜
          cat > release_body.md << 'RELEASE_BODY_EOF'
          ## ğŸ‰ Tauri Markdown Editor ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…

          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…:

          - **Windows**: `*-setup.exe` æ–‡ä»¶ (NSIS å®‰è£…ç¨‹åº,æ”¯æŒä¸­æ–‡ç•Œé¢)
          - **macOS**:
            - `aarch64.dmg` - Apple Silicon (M1/M2/M3)
            - `x64.dmg` - Intel å¤„ç†å™¨
          - **Linux**:
            - `.AppImage` - é€šç”¨æ ¼å¼
            - `.deb` - Debian/Ubuntu

          ### âœ¨ æ›´æ–°å†…å®¹

          ${{ steps.changelog.outputs.changelog }}

          ### ğŸ“ å®‰è£…è¯´æ˜

          #### Windows
          1. ä¸‹è½½ `*-setup.exe` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. é€‰æ‹©å®‰è£…è¯­è¨€(æ”¯æŒç®€ä½“ä¸­æ–‡å’Œè‹±æ–‡)
          4. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…

          #### macOS
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ `.dmg` æ–‡ä»¶
          2. æ‰“å¼€ DMG æ–‡ä»¶
          3. å°†åº”ç”¨æ‹–å…¥ Applications æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œæ—¶,å³é”®ç‚¹å‡»åº”ç”¨é€‰æ‹©"æ‰“å¼€"(ç»•è¿‡ Gatekeeper)

          #### Linux
          1. ä¸‹è½½ `.AppImage` æ–‡ä»¶
          2. æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x tauri-md_*.AppImage`
          3. è¿è¡Œ: `./tauri-md_*.AppImage`

          æˆ–ä½¿ç”¨ `.deb` åŒ…:
          ```bash
          sudo dpkg -i tauri-md_*.deb
          sudo apt-get install -f  # å®‰è£…ä¾èµ–
          ```

          ---

          **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v0.1.0...${{ github.ref_name }}
          RELEASE_BODY_EOF

          # æ›´æ–° Release ä¸ºæ­£å¼å‘å¸ƒå¹¶æ›´æ–°è¯´æ˜
          gh release edit ${{ github.ref_name }} \
            --draft=false \
            --latest \
            --notes-file release_body.md

